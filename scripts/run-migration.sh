#!/bin/bash

################################################################################
# GALOR Database Migration Script - Steps 3 & 4
# 
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ GALOR
# - –®–∞–≥ 3: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (0002_expand_cities_table.sql)
# - –®–∞–≥ 4: –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏ (seed_cities.sql)
################################################################################

set -e  # –ü—Ä–µ—Ä—ã–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

################################################################################
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
################################################################################

log_info "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."

if [ ! -f .env ]; then
    log_error ".env —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
source .env

if [ -z "$DATABASE_URL" ]; then
    log_error "DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ .env!"
    exit 1
fi

# –ü–∞—Ä—Å–∏–Ω–≥ DATABASE_URL
# –§–æ—Ä–º–∞—Ç: mysql://user:password@host:port/database
DB_USER=$(echo $DATABASE_URL | sed -n 's/.*:\/\/\([^:]*\):.*/\1/p')
DB_PASS=$(echo $DATABASE_URL | sed -n 's/.*:\/\/[^:]*:\([^@]*\)@.*/\1/p')
DB_HOST=$(echo $DATABASE_URL | sed -n 's/.*@\([^:]*\):.*/\1/p')
DB_PORT=$(echo $DATABASE_URL | sed -n 's/.*:\([0-9]*\)\/.*/\1/p')
DB_NAME=$(echo $DATABASE_URL | sed -n 's/.*\/\([^?]*\).*/\1/p')

log_success "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞"
log_info "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: $DB_NAME –Ω–∞ $DB_HOST:$DB_PORT"

################################################################################
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
################################################################################

log_info "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MySQL..."

if ! mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASS" -e "SELECT 1" > /dev/null 2>&1; then
    log_error "–ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ MySQL!"
    log_info "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:"
    log_info "  - MySQL –∑–∞–ø—É—â–µ–Ω: sudo systemctl status mysql"
    log_info "  - –ö—Ä–µ–¥–µ–Ω—à–∞–ª—ã –≤ .env –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã"
    log_info "  - –•–æ—Å—Ç –∏ –ø–æ—Ä—Ç –¥–æ—Å—Ç—É–ø–Ω—ã"
    exit 1
fi

log_success "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MySQL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"

################################################################################
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
################################################################################

log_info "–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö $DB_NAME..."

if ! mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASS" -e "USE $DB_NAME" > /dev/null 2>&1; then
    log_error "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö $DB_NAME –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!"
    log_info "–°–æ–∑–¥–∞–π—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö: CREATE DATABASE $DB_NAME;"
    exit 1
fi

log_success "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö $DB_NAME –Ω–∞–π–¥–µ–Ω–∞"

################################################################################
# –®–ê–ì 3: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
################################################################################

log_info "=== –®–ê–ì 3: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ ==="

MIGRATION_FILE="drizzle/migrations/0002_expand_cities_table.sql"

if [ ! -f "$MIGRATION_FILE" ]; then
    log_error "–§–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω: $MIGRATION_FILE"
    exit 1
fi

log_info "–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏: $MIGRATION_FILE"

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
if mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASS" "$DB_NAME" < "$MIGRATION_FILE"; then
    log_success "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞!"
else
    log_error "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–∏!"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü—ã
log_info "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü—ã cities..."
mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASS" "$DB_NAME" -e "DESCRIBE cities" | grep -E "countryCode|latitude|longitude|timezone" > /dev/null

if [ $? -eq 0 ]; then
    log_success "‚úÖ –í—Å–µ –Ω–æ–≤—ã–µ –ø–æ–ª—è –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
else
    log_error "‚ùå –ù–µ –≤—Å–µ –ø–æ–ª—è –±—ã–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã!"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–æ–≤
log_info "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–æ–≤..."
INDEX_COUNT=$(mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASS" "$DB_NAME" -e "SHOW INDEX FROM cities WHERE Key_name LIKE 'idx_cities%'" | wc -l)

if [ $INDEX_COUNT -gt 0 ]; then
    log_success "‚úÖ –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã ($((INDEX_COUNT-1)) –∏–Ω–¥–µ–∫—Å–æ–≤)"
else
    log_warning "‚ö†Ô∏è  –ò–Ω–¥–µ–∫—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã (–≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∏)"
fi

################################################################################
# –®–ê–ì 4: –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏
################################################################################

log_info "=== –®–ê–ì 4: –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏ ==="

SEED_FILE="drizzle/seed_cities.sql"

if [ ! -f "$SEED_FILE" ]; then
    log_error "–§–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω: $SEED_FILE"
    exit 1
fi

log_info "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑: $SEED_FILE"

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ seed —Å–∫—Ä–∏–ø—Ç–∞
if mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASS" "$DB_NAME" < "$SEED_FILE"; then
    log_success "‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!"
else
    log_error "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö!"
    exit 1
fi

################################################################################
# –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
################################################################################

log_info "=== –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ ==="

# –ü–æ–¥—Å—á–µ—Ç –≥–æ—Ä–æ–¥–æ–≤
CITY_COUNT=$(mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASS" "$DB_NAME" -se "SELECT COUNT(*) FROM cities")

log_info "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Ä–æ–¥–æ–≤ –≤ –ë–î: $CITY_COUNT"

if [ "$CITY_COUNT" -eq 15 ]; then
    log_success "‚úÖ –í—Å–µ 15 –≥–æ—Ä–æ–¥–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!"
elif [ "$CITY_COUNT" -lt 15 ]; then
    log_error "‚ùå –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–æ–ª—å–∫–æ $CITY_COUNT –≥–æ—Ä–æ–¥–æ–≤ –∏–∑ 15!"
    exit 1
else
    log_warning "‚ö†Ô∏è  –ó–∞–≥—Ä—É–∂–µ–Ω–æ –±–æ–ª—å—à–µ –≥–æ—Ä–æ–¥–æ–≤ —á–µ–º –æ–∂–∏–¥–∞–ª–æ—Å—å: $CITY_COUNT"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
CITIES_WITH_COORDS=$(mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASS" "$DB_NAME" -se "SELECT COUNT(*) FROM cities WHERE latitude IS NOT NULL AND longitude IS NOT NULL")

if [ "$CITIES_WITH_COORDS" -eq "$CITY_COUNT" ]; then
    log_success "‚úÖ –í—Å–µ –≥–æ—Ä–æ–¥–∞ –∏–º–µ—é—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã"
else
    log_error "‚ùå –ù–µ –≤—Å–µ –≥–æ—Ä–æ–¥–∞ –∏–º–µ—é—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã! ($CITIES_WITH_COORDS –∏–∑ $CITY_COUNT)"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–π–º–∑–æ–Ω
CITIES_WITH_TZ=$(mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASS" "$DB_NAME" -se "SELECT COUNT(*) FROM cities WHERE timezone IS NOT NULL")

if [ "$CITIES_WITH_TZ" -eq "$CITY_COUNT" ]; then
    log_success "‚úÖ –í—Å–µ –≥–æ—Ä–æ–¥–∞ –∏–º–µ—é—Ç —Ç–∞–π–º–∑–æ–Ω—ã"
else
    log_error "‚ùå –ù–µ –≤—Å–µ –≥–æ—Ä–æ–¥–∞ –∏–º–µ—é—Ç —Ç–∞–π–º–∑–æ–Ω—ã! ($CITIES_WITH_TZ –∏–∑ $CITY_COUNT)"
    exit 1
fi

# –í—ã–≤–æ–¥ —Å–ø–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–æ–≤
log_info "–°–ø–∏—Å–æ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤:"
mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASS" "$DB_NAME" -e "
SELECT 
    name, 
    country, 
    countryCode, 
    CONCAT(latitude, ', ', longitude) as coordinates, 
    timezone 
FROM cities 
ORDER BY country, name"

################################################################################
# –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
################################################################################

echo ""
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
log_success "üéâ –ú–ò–ì–†–ê–¶–ò–Ø –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–ê! üéâ"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""
log_info "–í—ã–ø–æ–ª–Ω–µ–Ω–æ:"
log_info "  ‚úÖ –®–∞–≥ 3: –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î (7 –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π, 2 –∏–Ω–¥–µ–∫—Å–∞)"
log_info "  ‚úÖ –®–∞–≥ 4: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö (15 –≥–æ—Ä–æ–¥–æ–≤ —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ –∏ —Ç–∞–π–º–∑–æ–Ω–∞–º–∏)"
echo ""
log_info "–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
log_info "  1. –û–±–Ω–æ–≤–∏—Ç–µ DB_MIGRATION_GUIDE.md - –ø–æ–º–µ—Ç—å—Ç–µ –®–∞–≥–∏ 3-4 –∫–∞–∫ COMPLETED"
log_info "  2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π"
log_info "  3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Å—Ç—Ä–∞–Ω–∞–º –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ"
echo ""
log_info "–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: docs/MIGRATION_EXECUTION.md"
echo ""

exit 0
